# 規格表達規則

## 核心原則：無腦補或任意假設原則
**嚴格遵守原始規格文本內容，如果需求中沒有明確寫出的欄位、規則、條件或行為，就不要加入。不要擅自假設、推測或補充任何需求中不存在的內容。**

---

# 規格表達格式

## DBML 格式（資料模型）
用於描述實體關係模型 (ERM)，所有實體寫在同一個 `spec/erm.dbml` 檔案中。

基本結構：
- **Table**：代表實體
- **Column**：包含名稱、資料型別 (int, long, float, bool, string)
- **Note**：對實體、屬性的定義說明，可額外條列跨屬性不變條件
- **Relationship**：實體間的關聯

## Gherkin Language 格式（功能模型）
用於描述功能規格，採用三層式結構：Feature > Rule > Example。每個功能獨立一份文件於 `spec/features/<中文功能簡稱>.feature`。

### Feature（功能）
- 定義：使用者與系統的請求交互點，必須存在明確的交互時機

### Rule（規則）
- 每個功能涵蓋 1..* 條規則

### Example（例子）
- 使用 Gherkin 語法 (Given-When-Then) 描述規則的具體案例
- 若規格文本中無可用例子，在 Rule 下標記 `#TODO`，該 Rule 狀態列為 Missing
- 應涵蓋邊界條件與不同值域類別

---

# 資料模型萃取規則

## A. 識別「實體 (Entity)」
每個實體都是系統中需要持久化的資料物件。

- 只萃取規格中明確提到的實體
- 實體名稱使用規格中的術語，不要自行創造
- 不要添加規格中未提及的實體

## B. 萃取實體的「屬性 (Attribute)」
針對每個實體，萃取其屬性：

- 只萃取規格中明確提到或可直接推導的屬性
- 每個屬性必須指定資料型別：**int, long, float, bool, string**
- 每個屬性必須有 **note** 說明其定義與用途
- 如果規格中有提到屬性的限制條件（如 > 0, >= 0, 必須唯一等），在 note 中明確標註
- 不要添加規格中沒有提到的「預留欄位」或「可能需要的欄位」

## C. 標註「跨屬性不變條件」
若規格中明確提及屬性間的計算關係或約束條件：

- 在實體的 Note 中條列跨屬性不變條件
- 例如：總額 = 單價 × 數量
- 只記錄規格中明確提到的約束，不要臆測

## D. 識別實體之間的「關係 (Relationship)」
- 只標註規格中明確提到的關聯關係
- 使用 DBML 的 ref 語法描述關聯
- 明確標示關聯類型（一對一、一對多、多對多）

## E. 記錄實體的整體說明
- 在 Table 的 Note 中簡述此實體的用途
- 如果實體之間有關聯，在 Note 中註明（如：Cart 1:N CartItem）

---

# 功能模型萃取規則

## A. 萃取「功能 (Feature)」
每個功能都是使用者與系統的請求交互點，若沒有明確交互時機則不被視為功能。

- 好比說，以會員系統為例，會員會向系統註冊、登入和登出等等，那這三者都各為一道獨立的功能
- 只萃取規格中明確提到的功能，不要推測「可能需要的功能」
- 功能命名應清晰且反映使用者意圖

## B. 萃取功能的「規則 (Rule)」
針對每個功能，從原始規格文本中萃取其「規則 (Rule)」。規則為此功能在實際執行時系統必須遵守的條件。

### 規則分類
- **前置條件 (Pre-condition)**：功能執行前需做的驗證，若沒通過驗證則不履行功能
- **後置條件 (Post-condition)**：若通過前置條件，則系統必須保證達成的條件，好比系統狀態的更新

### 規則萃取原則
- 每個前置條件 or 後置條件都必須為一條獨立的 Rule
- **Rule 必須原子化**，分割到不可分割為止，每一個 Rule 只驗證一件事
- 每個功能至少萃取出一條規則
- 只萃取規格中明確提到的規則，不要添加「合理的驗證」或「應該要有的檢查」
- 規則描述必須可驗證，避免使用模糊的形容詞

## C. 萃取規則的「例子 (Example)」
針對每個規則，從原始規格文本中尋找是否有「例子 (Example)」能說明此規則。

- 使用 **Gherkin 語法 (Given-When-Then)** 描述此 Example
- 如果無法從文本中找到任何例子，則不要強硬給予任何例子，在 Rule 下標記 **#TODO** 即可
- 不要編造例子或假設測試情境
- Example 應涵蓋邊界條件與不同值域類別（若規格中有提供）
- 每個 Example 至少都有 "When step"，When 與該 Feature 的系統交互相關，好比如果該 Feature 為「登入」，則 When 必定是與此功能的交互時機，也就是「登入」。
- 每一個 step 必須容易被翻譯成測試的程式碼），不可以放入過度描述性質而非資料性質的字串。（好比在 then 中撰寫：`then 執行的順序應該如下：`，順序難以藉由測試自動化驗證。）
- Feature File 中的句型盡可能一致，避免句型不同而造成後續測試程式實作上亂章無序或「句型不同、語義卻相同，使得 StepDef 需重複實作」的困擾。
- `Then` 的語句中只能描述系統的實際狀態資料，不能撰寫描述性的語句。好比：
  - 錯誤示範：
    ```
      Then 客人獲得一道飯糰餐點
      And 此餐點沒有附贈點心
    ```
  - 正確示範：
    ```
    Then 客人獲得底下餐點
      | name |
      | 飯糰 |
    ```
- 如果在此場景下，此操作系統不允許、且需表達錯誤，則一律使用底下格式撰寫 Then：`Then 操作失敗`
- `Then` 必須用「資料」來描述業務功能的驗收，請勿用描述「應該」，而是描述「值必須為多少」。好比：
  - 錯誤示範：`Then 應成功折價 1000 元`
  - 正確示範：
    ```
    Then 訂單的原始總額為 1500 元
    And 訂單的優惠後價格為 500 元
    ```

---

# 輸出格式規範

## DBML 格式要求
將資料模型以 DBML 格式輸出到 `spec/erm.dbml`（所有實體寫在同一個檔案中）。

**格式要求：**
- 檔案必須嚴格遵照 DBML 語法格式
- 每個 **Table** 代表一個實體
- 每個 **Column** 必須包含：
  - 名稱
  - 資料型別 (int, long, float, bool, string)
  - **note** 說明（定義、用途、限制條件）
- 每個 **Table** 必須有 **Note** 說明其用途
- 在 Table Note 中可額外條列跨屬性不變條件
- 使用 **ref** 描述實體之間的關聯關係

## Gherkin Language 格式要求
將每個 Feature 以及其涵蓋的 Rules/Examples，以 Gherkin Language 依序輸出到 `spec/features/` 中。

**檔案組織：**
- 每個功能獨立一份文件
- 檔案名稱為 `<中文功能簡稱>.feature`

**格式要求：**
- 檔案必須嚴格遵照 Gherkin Language 的格式
- 階層結構：Feature > Rule > Example
- 使用英文版本的 Given/When/Then keyword
- 每個 step statement 主要以中文描述
- 如果有 DataTable，欄位名稱以英文描述
- 缺少 Example 的 Rule 必須標記 `#TODO`